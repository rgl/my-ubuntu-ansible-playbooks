- name: Install dnsmasq
  ansible.builtin.apt:
    name: dnsmasq

- name: Disable the systemd-resolved host dns resolver
  ansible.builtin.systemd:
    name: systemd-resolved
    masked: true
    enabled: false
    state: stopped

- name: Configure dnsmasq as the host dns resolver
  block:
    - name: Configure dnsmasq
      ansible.builtin.template:
        src: dnsmasq.conf.j2
        dest: /etc/dnsmasq.d/local.conf
      register: configure
    - name: Restart dnsmasq
      when: configure.changed
      ansible.builtin.systemd:
        name: dnsmasq
        state: restarted
    - name: Configure resolv.conf
      ansible.builtin.copy:
        content: |
          nameserver 127.0.0.1
        dest: /etc/resolv.conf
